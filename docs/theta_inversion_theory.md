# Theta 反演（`theta_est_hist`）推导与实现说明

本文档解释 `theta_est_hist` 特征的理论来源：如何从 DC 归一化导频谐波幅度 `(h1_norm, h2_norm)` 反演得到工作角估计 `θ̂`，并将其编码为 `(sin θ̂, cos θ̂)` 输入策略网络，从而在 RF 功率变化（`J0(beta_rf)` 缩放）下保持鲁棒性，同时避免仅做“形状归一化”带来的信息塌缩与闭环不稳定。

对应代码：

- 反演实现：`mzm/dither_controller.py` 中 `_estimate_theta_from_harmonics_np()` / `_estimate_theta_from_harmonics_torch()`
- 特征模式：`feature_mode='theta_est_hist'`（数据集/回放均支持）

---

## 1. 背景：可观测量与 RF 干扰建模

系统约束是：只能从 PD 的低频导频（dither）分量中测得 1f/2f 的谐波幅度（幅值，非带符号 I/Q）。

为了消除光功率（`Pin`）整体缩放，特征使用 DC 归一化：

- `h1_norm = A1 / I_dc`
- `h2_norm = A2 / I_dc`

其中 `A1, A2` 是导频频率 `f_dither` 的 1f/2f 幅度，`I_dc` 是 PD 电流均值（或等效 DC 分量）。

RF 干扰在本项目中采用解析缩放建模：高速 RF 调制在带宽受限的 PD/测量链路下，等效为把 MZM 传输函数中的“干涉项”乘上 `J0(beta_rf)`（见 `mzm/model.py` 的 `J0 scaling` 部分）。

---

## 2. 小信号模型：把导频响应写成 “常数项 + 干涉项”

对双臂 MZM（含有限消光比 ER 的幅度不平衡系数 `gamma`），PD 电流可以写为：

```
I(t) = K * [ a + b * cos( θ + beta_d * sin(ω_d t) ) ]
```

变量含义：

- `θ = π * V_bias / Vpi`：当前偏置对应的工作角（范围 0..π）
- `beta_d = π * V_dither_amp / Vpi`：导频深度
- `ω_d = 2π f_dither`
- `K`：整体比例系数（包含 `Pin`、插入损耗、响应度等）
- `a = 1 + gamma^2`（只与 ER 有关）
- `b = 2*gamma*J0(beta_rf)`（RF 通过 `J0(beta_rf)` 进入，RF 功率变化 ⇒ `b` 变化）

这里把 RF 的影响集中到 `b`，把它视为 **nuisance parameter（干扰参数）**。

---

## 3. 1f/2f 幅度与 `sinθ / cosθ` 的关系（Jacobi–Anger 展开）

对 `cos( θ + beta_d*sin(ω_d t) )` 使用 Jacobi–Anger 展开并保留 1f/2f 主项，可得：

- 1f 分量幅度与 `|sinθ| * J1(beta_d)` 成正比
- 2f 分量幅度与 `|cosθ| * J2(beta_d)` 成正比

更关键的是：这两个幅度都带相同的公共因子 `K*b`。

---

## 4. DC 归一化后得到的两条方程（消掉 `K`，但 `b` 留在分母）

由于 `I_dc = mean(I(t)) = K * [ a + b*J0(beta_d)*cosθ ]`，并且 lock-in 用的是 AC 分量（去掉均值），最终 DC 归一化的 1f/2f 幅度可写为：

```
h1 = 2*b*J1(beta_d)*|sinθ| / ( a + b*J0(beta_d)*cosθ )
h2 = 2*b*J2(beta_d)*|cosθ| / ( a + b*J0(beta_d)*cosθ )
```

其中 `h1,h2` 对应实现里的 `h1_norm,h2_norm`。

观察：

- `K` 被消掉 ⇒ 对光功率（`Pin`）整体缩放鲁棒
- `b` 出现在分子和分母 ⇒ 仅 DC 归一化仍会对 RF（`J0(beta_rf)`）敏感

因此需要进一步“利用这两条方程联立解出 `θ`”，并把 `b` 当 nuisance 一并估计/吸收。

---

## 5. 角度反演：先解出折叠角 `θ_abs`，再用先验选分支

### 5.1 折叠角：用比值消去 nuisance 的公共因子

定义：

```
p = h1 / (2*J1(beta_d)) = b*|sinθ| / D
q = h2 / (2*J2(beta_d)) = b*|cosθ| / D
D = a + b*J0(beta_d)*cosθ
```

则

```
p/q = |tanθ|
θ_abs = atan2(p, q)   ∈ [0, π/2]
```

这一步不需要知道 `b`，并且对 RF 缩放相对不敏感（因为 `b/D` 在 p,q 中被比值消掉）。

### 5.2 分支二义性：`θ` 与 `π-θ` 在幅度观测下不可区分

仅幅度观测会丢失 `cosθ` 的符号，所以真实角度只能是两者之一：

```
θ ∈ { θ_abs,  π - θ_abs }
```

这不是数值问题，而是信息缺失导致的先天二义性。

### 5.3 引入偏置先验：用 `θ_prior = π*V/Vpi` 选分支（闭环可实现）

在闭环中，控制器始终知道自己输出的当前偏置电压 `V`（DAC code），因此可以构造先验：

```
θ_prior = π * V / Vpi
```

分支选择规则：

```
θ_hat = argmin_{θ_candidate ∈ {θ_abs, π-θ_abs}} |θ_candidate - θ_prior|
```

这一步不需要额外传感器，仅依赖控制器已知的动作变量 `V` 与标定参数 `Vpi`，因此在真实 MZM 链路（单片机）中可实现。

### 5.4 nuisance 参数 `b` 的估计（可用于诊断/置信度）

在分支确定后，可以从 `p = b*|sinθ| / (a + b*J0(beta_d)*cosθ)` 反推 `b`（用于调试或置信度评估）：

- 令 `w = p / |sinθ|`
- 根据 `cosθ` 的符号分别得到 `b_plus/b_minus`

实现中会对 `b` 做范围约束（`0 ≤ b ≤ 2*gamma`），并在 trace 中输出 `b_est` 便于分析。

---

## 6. 为什么喂给网络的是 `(sin θ̂, cos θ̂)` 而不是 `θ̂`

将观测表示成 `(sin θ̂, cos θ̂)` 有三点好处：

1) **连续性**：角度在 0/π 附近直接用 `θ` 会出现边界不连续问题；`sin/cos` 在圆上是连续的。
2) **与目标编码一致**：目标角度本来编码为 `(sin θ*, cos θ*)`，观测也用同一表示，有利于网络学习“把观测推向目标”。
3) **差分稳定**：使用 `Δsin, Δcos` 的历史差分数值有界，闭环更稳。

最终输入特征为 7 维：

```
x_k = [ sin(θ̂_k), cos(θ̂_k), Δsin(θ̂), Δcos(θ̂), ΔV_{k-1}, sin(θ*), cos(θ*) ]
```

---

## 7. RF 鲁棒性来自哪里

RF 在解析模型里只通过 `b = 2*gamma*J0(beta_rf)` 进入上面的两条方程。角度反演使用 `(h1,h2)` 的结构关系把 `b` 当 nuisance 吸收掉（折叠角用比值消去公共缩放，最终 `θ̂` 主要由 `p/q` 决定），因此对 RF 功率变化具有鲁棒性。

需要注意：当 RF=0 时 `J0(beta_rf)=1`，干涉项最强，系统更容易进入深消光/分母变小的区域，反演会对噪声更敏感；这也是 RF=0 常常更“难”的原因之一。

---

## 8. 数值与工程注意事项（与实现一致）

- `eps`：用于避免除零/极小分母造成数值爆炸。
- `max_step_V`：回放中对 `dv` 做限幅，避免少量 outlier 把闭环打崩，降低评估 Std。
- `Vpi` 漂移：先验分支选择依赖 `Vpi` 的量级正确；实际系统中建议定期校准或慢速自适应。

